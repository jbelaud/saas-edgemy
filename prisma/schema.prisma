generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Subscriber {
  id        String       @id @default(cuid())
  email     String       @unique
  role      WaitlistRole
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  firstName String?

  @@map("subscribers")
}

model Plan {
  id             String   @id @default(cuid())
  key            String   @unique  // "PRO", "LITE", "VIP", etc.
  name           String              // "Edgemy Pro", "Edgemy Lite"
  monthlyPrice   Int                 // en centimes (ex: 3900 pour 39€)
  yearlyPrice    Int                 // en centimes (ex: 39900 pour 399€)
  features       Json?               // Features disponibles pour ce plan
  requiresStripe Boolean  @default(true) // false pour LITE (pas de Stripe pour paiement joueur)
  isActive       Boolean  @default(true)  // Permet de désactiver un plan
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model account {
  id                    String    @id
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime
  user                  user      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
}

model coach {
  id                     String            @id @default(cuid())
  userId                 String            @unique
  slug                   String            @unique
  firstName              String
  lastName               String
  bio                    String?
  bannerUrl              String?
  avatarUrl              String?
  status                 CoachStatus       @default(INACTIVE)
  planKey                String            @default("PRO") // Référence à Plan.key (PRO, LITE, etc.)
  stripeAccountId        String?
  stripeCustomerId       String?           // ID client Stripe pour abonnement
  subscriptionId         String?           // ID abonnement Stripe
  subscriptionStatus     SubscriptionStatus? // Statut abonnement
  subscriptionPlan       SubscriptionPlan? // Plan (MONTHLY/YEARLY/FREE_TRIAL)
  currentPeriodEnd       DateTime?         // Fin période abonnement
  isOnboarded            Boolean           @default(false) // Stripe Connect complété
  isDiscordConnected     Boolean           @default(false) // OAuth Discord validé
  freeTrialUsed          Boolean           @default(false) // Code promo déjà utilisé
  freeTrialStartDate     DateTime?         // Date début essai gratuit
  freeTrialEndDate       DateTime?         // Date fin essai gratuit
  paymentPreferences     String[]          @default([])    // Moyens de paiement préférés pour plan LITE (ex: ["USDT", "Wise", "Revolut"])

  // TVA du coach (pour calcul TVA correcte)
  isVATRegistered        Boolean           @default(false) // Le coach est-il assujetti à la TVA ?
  vatNumber              String?           // Numéro de TVA intracommunautaire (si applicable)

  badges                 String[]
  formats                String[]
  stakes                 String?
  roi                    Float?
  experience             Int?
  languages              String[]
  twitchUrl              String?
  youtubeUrl             String?
  twitterUrl             String?
  discordUrl             String?
  presentationVideoUrl   String?           // URL YouTube de présentation
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  timezone               String?
  methodology            String?
  announcements          Announcement[]
  availabilities         Availability[]
  coachingPackages       CoachingPackage[]
  reservations           Reservation[]
  notes                  CoachNote[]
  channels               CoachPlayerChannel[]
  notifications          CoachNotification[]
  user                   user              @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CoachDraft {
  id              String   @id @default(cuid())
  userId          String   @unique
  firstName       String?
  lastName        String?
  bio             String?
  formats         String[]
  stakes          String?
  roi             Float?
  experience      Int?
  languages       String[]
  twitchUrl       String?
  youtubeUrl      String?
  twitterUrl      String?
  discordUrl      String?
  avatarUrl       String?
  bannerUrl       String?
  stripeAccountId String?
  subscriptionId  String?
  currentStep     Int      @default(1)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            user     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Announcement {
  id               String             @id @default(cuid())
  coachId          String
  type             String             @default("STRATEGY")
  title            String
  slug             String             @unique
  description      String
  priceCents       Int
  durationMin      Int
  variant          String?
  format           String?
  abiRange         String?
  tags             String[]
  reviewType       String?
  reviewSupport    String?
  toolName         String?
  toolObjective    String?
  prerequisites    String?
  mentalFocus      String?
  isActive         Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  coach            coach              @relation(fields: [coachId], references: [id], onDelete: Cascade)
  packs            AnnouncementPack[]
  coachingPackages CoachingPackage[]
  reservations     Reservation[]
}

model AnnouncementPack {
  id              String        @id @default(cuid())
  announcementId  String
  hours           Int
  totalPrice      Int
  discountPercent Int?
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  announcement    Announcement  @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  reservations    Reservation[]

  @@index([announcementId])
}

model Availability {
  id        String   @id @default(cuid())
  coachId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  start     DateTime
  end       DateTime
  coach     coach    @relation(fields: [coachId], references: [id], onDelete: Cascade)

  @@index([coachId])
  @@index([start])
}

model Reservation {
  id               String            @id @default(cuid())
  announcementId   String
  coachId          String
  playerId         String
  packId           String?
  sessionNumber    Int?
  startDate        DateTime
  endDate          DateTime
  status           ReservationStatus @default(PENDING)
  paymentStatus    PaymentStatus     @default(PENDING)
  type             ReservationType   @default(SINGLE) // Type: SINGLE ou PACK
  priceCents       Int                                 // Prix payé par le joueur (en centimes)
  commissionCents  Int               @default(0)       // Commission Edgemy Phase 1 (en centimes)
  coachEarningsCents Int             @default(0)       // Gains du coach (en centimes)
  stripeFeeCents   Int               @default(0)
  edgemyFeeCents   Int               @default(0)
  serviceFeeCents  Int               @default(0)
  coachNetCents    Int               @default(0)

  // Comptabilité TVA Edgemy
  edgemyRevenueHT       Int?              // Revenu Edgemy HT (en centimes)
  edgemyRevenueTVACents Int?              // TVA sur revenu Edgemy (en centimes, 20% en France)

  isPackage        Boolean           @default(false)
  sessionsCount    Int?

  // Paiement Stripe
  stripePaymentId  String?                             // ID du PaymentIntent Stripe
  stripeSessionId  String?                             // ID de la session Stripe Checkout

  // Transfert au coach (nouveau système)
  stripeTransferId     String?           // ID du transfer Stripe vers le coach
  transferStatus       TransferStatus    @default(PENDING) // Statut du transfer
  transferredAt        DateTime?         // Date du transfer au coach

  // Remboursements
  refundStatus         RefundStatus      @default(NONE)
  refundAmount         Int?              // Montant remboursé (centimes)
  refundReason         String?           // Raison du remboursement
  refundedAt           DateTime?         // Date du remboursement

  // Annulation
  cancelledBy          CancelledBy?      // COACH ou PLAYER
  cancellationReason   String?           // Raison annulation
  cancelledAt          DateTime?         // Date annulation

  // Discord
  discordChannelId String?                             // ID du salon Discord privé coach-joueur

  // Dates
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  // Relations
  packageSession   PackageSession?
  refundLogs       RefundLog[]
  transferLogs     TransferLog[]
  announcement     Announcement      @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  coach            coach             @relation(fields: [coachId], references: [id], onDelete: Cascade)
  pack             AnnouncementPack? @relation(fields: [packId], references: [id])
  player           user              @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([packId])
  @@index([playerId])
  @@index([coachId])
  @@index([transferStatus])
  @@index([startDate])
}

model CoachPlayerChannel {
  id                String   @id @default(cuid())
  coachId           String
  playerId          String
  discordChannelId  String   // ID du salon texte Discord
  discordVoiceId    String?  // ID du salon vocal Discord
  createdAt         DateTime @default(now())
  lastUsedAt        DateTime @updatedAt
  
  coach  coach @relation(fields: [coachId], references: [id], onDelete: Cascade)
  player user  @relation("PlayerChannels", fields: [playerId], references: [id], onDelete: Cascade)
  
  @@unique([coachId, playerId])
  @@index([coachId])
  @@index([playerId])
}

model CoachingPackage {
  id              String           @id @default(cuid())
  playerId        String
  coachId         String
  announcementId  String
  totalHours      Int
  remainingHours  Int
  priceCents      Int              // Prix total payé par le joueur
  commissionCents Int              @default(0) // Commission Edgemy
  coachEarningsCents Int           @default(0) // Total que doit recevoir le coach
  stripeFeeCents  Int              @default(0)
  edgemyFeeCents  Int              @default(0)
  serviceFeeCents Int              @default(0)
  coachNetCents   Int              @default(0)
  sessionPayoutCents Int           @default(0)
  sessionsCompletedCount Int       @default(0)
  sessionsTotalCount Int       @default(0)

  // Paiement Stripe
  stripePaymentId String?          // ID du PaymentIntent

  // Transfert progressif au coach (par session)
  finalTransferId       String?
  finalTransferredAt    DateTime?
  transferStatus        PackageTransferStatus @default(PENDING)

  // Statut du pack
  status          PackageStatus    @default(ACTIVE)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  announcement    Announcement     @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  coach           coach            @relation(fields: [coachId], references: [id], onDelete: Cascade)
  player          user             @relation(fields: [playerId], references: [id], onDelete: Cascade)
  sessions        PackageSession[]

  @@index([playerId])
  @@index([coachId])
  @@index([transferStatus])
}

model PackageSession {
  id              String               @id @default(cuid())
  packageId       String
  reservationId   String?              @unique
  startDate       DateTime
  endDate         DateTime
  durationMinutes Int
  status          PackageSessionStatus @default(SCHEDULED)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  package         CoachingPackage      @relation(fields: [packageId], references: [id], onDelete: Cascade)
  reservation     Reservation?         @relation(fields: [reservationId], references: [id])

  @@index([packageId])
}

model CoachNote {
  id        String   @id @default(cuid())
  coachId   String
  playerId  String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  coach     coach    @relation(fields: [coachId], references: [id], onDelete: Cascade)
  player    user     @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([coachId])
  @@index([playerId])
  @@index([coachId, playerId])
}

model CoachNotification {
  id              String   @id @default(cuid())
  coachId         String
  playerId        String   // ID du joueur qui a notifié
  playerEmail     String?  // Email du joueur (snapshot)
  playerName      String?  // Nom du joueur (snapshot)
  isFollowUp      Boolean  @default(false) // true si c'est une relance
  emailSent       Boolean  @default(false)
  discordSent     Boolean  @default(false)
  createdAt       DateTime @default(now())

  coach  coach @relation(fields: [coachId], references: [id], onDelete: Cascade)
  player user  @relation("CoachNotifications", fields: [playerId], references: [id], onDelete: Cascade)

  @@index([coachId])
  @@index([playerId])
  @@index([coachId, playerId])
  @@index([createdAt])
}

model RefundLog {
  id              String   @id @default(cuid())
  reservationId   String
  amount          Int      // Montant remboursé (centimes)
  reason          String
  stripeRefundId  String
  initiatedBy     String?  // ID de l'utilisateur qui a initié le remboursement
  createdAt       DateTime @default(now())

  reservation     Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([reservationId])
  @@index([createdAt])
}

model TransferLog {
  id              String   @id @default(cuid())
  reservationId   String
  amount          Int      // Montant transféré (centimes)
  stripeTransferId String
  status          String   // pending, paid, failed, canceled
  transferType    String   // session_completion, cancellation_compensation, pack_first_half, pack_final_half
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  reservation     Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([reservationId])
  @@index([status])
  @@index([createdAt])
}

model player {
  id        String   @id @default(cuid())
  userId    String   @unique
  abi       Float?
  formats   String[]
  goals     String?
  winnings  Float?
  createdAt DateTime @default(now())
  firstName String?
  lastName  String?
  timezone  String?
  updatedAt DateTime @updatedAt
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model user {
  id               String            @id
  email            String?           @unique
  emailVerified    Boolean           @default(false)
  name             String?
  image            String?
  role             Role              @default(USER)
  discordId        String?           @unique
  createdAt        DateTime          @default(now())
  updatedAt        DateTime
  coachDraft       CoachDraft?
  coachingPackages CoachingPackage[]
  reservations     Reservation[]
  coachNotes       CoachNote[]
  playerChannels   CoachPlayerChannel[] @relation("PlayerChannels")
  coachNotifications CoachNotification[] @relation("CoachNotifications")
  adminLogs        AdminLog[]
  account          account[]
  coach            coach?
  player           player?
  session          session[]
}

model verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime

  @@unique([identifier, value])
}

model AdminLog {
  id        String   @id @default(cuid())
  action    String
  details   String?
  severity  LogSeverity @default(INFO)
  source    String?
  createdAt DateTime @default(now())
  adminId   String?
  admin     user?    @relation(fields: [adminId], references: [id], onDelete: SetNull)

  @@index([adminId])
  @@index([createdAt])
  @@index([severity])
}

enum Role {
  USER
  PLAYER
  COACH
  ADMIN
}

enum WaitlistRole {
  PLAYER
  COACH
  ADMIN
}

enum CoachStatus {
  INACTIVE
  PENDING_REVIEW
  ACTIVE
  SUSPENDED
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PackageStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum PackageSessionStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  EXTERNAL_PENDING  // En attente de paiement externe (plan LITE)
  EXTERNAL_PAID     // Payé en externe, confirmé par le coach
}

enum ReservationType {
  SINGLE
  PACK
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  TRIALING
}

enum SubscriptionPlan {
  MONTHLY
  YEARLY
  FREE_TRIAL
}

enum LogSeverity {
  INFO
  WARNING
  ERROR
}

enum TransferStatus {
  PENDING        // En attente de la session
  TRANSFERRED    // Transféré au coach
  FAILED         // Échec du transfer
  CANCELLED      // Annulé (remboursement)
}

enum RefundStatus {
  NONE           // Pas de remboursement
  PARTIAL        // Remboursement partiel
  FULL           // Remboursement total
}

enum CancelledBy {
  COACH
  PLAYER
}

enum PackageTransferStatus {
  PENDING              // Aucun transfer
  PARTIALLY_TRANSFERRED // Au moins une session payée
  FULLY_TRANSFERRED    // Toutes les sessions payées
}
