---
globs: src/lib/**
alwaysApply: false
---
# RÃ¨gle - Organisation des Fichiers Helper/Utils Isomorphiques

## Principe GÃ©nÃ©ral

Les fichiers helper et utils doivent Ãªtre **le plus possible isomorphiques** (compatibles front/back). Cela permet une meilleure rÃ©utilisabilitÃ© du code et Ã©vite la duplication de logique.

## RÃ¨gles d'Organisation

### âœ… Cas Acceptables

1. **Helper purement isomorphique** : Code compatible client et serveur
   ```typescript
   // âœ… utils/date.ts - Fonctionne partout
   export const formatDate = (date: Date): string => {
     return date.toLocaleDateString('fr-FR')
   }
   ```

2. **Helper spÃ©cifique serveur** : Code exclusivement serveur
   ```typescript
   // âœ… helpers/auth.server.ts - Serveur uniquement
   import 'server-only'
   export const validateServerToken = (token: string) => { ... }
   ```

3. **Helper spÃ©cifique client** : Code exclusivement client
   ```typescript
   // âœ… helpers/dom.client.ts - Client uniquement
   export const getElementPosition = (el: HTMLElement) => { ... }
   ```

### âš ï¸ Cas ProblÃ©matique

**Helper non-isomorphique utilisÃ© dans les 2 environnements** :
```typescript
// âŒ PROBLÃˆME : MÃ©lange code client/serveur dans le mÃªme fichier
export const blogHelper = {
  // Code commun
  generateSlug: (title: string) => { ... },
  
  // Code serveur uniquement
  readMDXFile: (path: string) => fs.readFileSync(path),
  
  // Code client uniquement
  saveToLocalStorage: (data: any) => localStorage.setItem(...)
}
```

## Solution : Pattern de Splitting

### ğŸ”§ Exemple Concret : Blog Helpers

RÃ©fÃ©rence : [blog.ts](mdc:src/lib/helper/blog.ts), [blog.server.ts](mdc:src/lib/helper/blog.server.ts), [blog.client.ts](mdc:src/lib/helper/blog.client.ts)

#### 1. **Fichier Commun** : `blog.ts`
```typescript
// Interface et fonctions isomorphiques
export interface BlogPost {
  slug: string
  title: string
  description: string
  readTime: string
  content?: string
}

export const generateSlug = (title: string): string => {
  // Logique pure, fonctionne partout
  return title
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .trim()
}
```

#### 2. **Fichier Serveur** : `blog.server.ts`
```typescript
import 'server-only'
import fs from 'fs'
import { BlogPost } from './blog'

// Fonctions serveur uniquement
export function getMDXSlugs(): string[] { ... }
export function getMDXContent(slug: string): string { ... }
export function getAllBlogPosts(): BlogPost[] { ... }
```

#### 3. **Fichier Client** : `blog.client.ts`
```typescript
import { BlogPost } from './blog'

// Fonctions client uniquement
export const blogStorage = {
  savePost: (post: BlogPost): void => {
    if (typeof window !== 'undefined') {
      localStorage.setItem(`blog-post-${post.slug}`, JSON.stringify(post))
    }
  }
}
```

## Convention de Nommage

### Structure des Fichiers
```
src/lib/helper/
â”œâ”€â”€ feature.ts          # Code isomorphique commun
â”œâ”€â”€ feature.server.ts   # Code spÃ©cifique serveur
â””â”€â”€ feature.client.ts   # Code spÃ©cifique client
```

### Suffixes Obligatoires
- **`.server.ts`** : Code serveur uniquement (avec `import 'server-only'`)
- **`.client.ts`** : Code client uniquement
- **`.ts`** : Code isomorphique (sans suffixe)

## Imports et Utilisation

### âœ… Bonnes Pratiques
```typescript
// Dans un Server Component
import { generateSlug } from '@/lib/helper/blog'
import { getAllBlogPosts } from '@/lib/helper/blog.server'

// Dans un Client Component  
import { generateSlug } from '@/lib/helper/blog'
import { blogStorage } from '@/lib/helper/blog.client'
```

### âŒ Ã‰viter
```typescript
// âŒ Import serveur dans du code client
import { getAllBlogPosts } from '@/lib/helper/blog.server' // ERREUR

// âŒ Import client dans du code serveur
import { blogStorage } from '@/lib/helper/blog.client' // ERREUR
```

## Checklist de Refactorisation

### ğŸ” **Quand Splitter un Helper ?**
- [ ] Le fichier contient du code `fs`, `path`, ou autres APIs Node.js ?
- [ ] Le fichier utilise `window`, `document`, `localStorage` ?
- [ ] Le fichier est importÃ© Ã  la fois cÃ´tÃ© client ET serveur ?
- [ ] Les fonctions ont des comportements diffÃ©rents selon l'environnement ?

### ğŸ› ï¸ **Ã‰tapes de Splitting**
- [ ] Identifier le code vraiment isomorphique
- [ ] Extraire les types/interfaces dans le fichier commun
- [ ] DÃ©placer le code serveur vers `.server.ts`
- [ ] DÃ©placer le code client vers `.client.ts`
- [ ] Ajouter `import 'server-only'` dans les fichiers serveur
- [ ] Mettre Ã  jour tous les imports

### âœ… **Validation**
- [ ] Le fichier commun ne contient que du code isomorphique
- [ ] Pas d'erreur de build cÃ´tÃ© client/serveur
- [ ] Les imports sont corrects dans tous les contextes
- [ ] La logique mÃ©tier n'est pas dupliquÃ©e

## Avantages de cette Approche

### ğŸš€ **Performance**
- Bundles client plus lÃ©gers (pas de code serveur)
- Tree-shaking optimisÃ©
- Pas de polyfills inutiles

### ğŸ”’ **SÃ©curitÃ©**
- Code serveur protÃ©gÃ© par `server-only`
- Pas de fuite de logique backend vers le client
- APIs sensibles isolÃ©es

### ğŸ§¹ **MaintenabilitÃ©**
- SÃ©paration claire des responsabilitÃ©s
- Code rÃ©utilisable maximisÃ©
- Pas de conditions `if (typeof window !== 'undefined')`

**Objectif** : Code propre, performant et sÃ©curisÃ© avec une rÃ©utilisabilitÃ© maximale.